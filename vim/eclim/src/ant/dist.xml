<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (C) 2005 - 2009  Eric Van Dewoestine

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<project name="dist" default="dist" basedir="../..">

  <!--
    - Target to validate the jvm version before building distributables
    -->
  <target name="validate">
    <condition property="valid.jvm">
      <equals arg1="${ant.java.version}" arg2="${javac.target}"/>
    </condition>
    <fail unless="valid.jvm"
        message="Distribution must be built with jdk ${javac.target}"/>
  </target>

  <!--
    - Target for creating distributable files.
    -->
  <target name="dist" depends="validate,clean,build,javadoc,docs,vimdocs"
      description="Creates the distributable files.">
    <mkdir dir="${build.installer}"/>

    <!-- docs archive -->
    <zip destfile="${build.plugins}/org.eclim_${eclim.version}/doc.zip">
      <fileset dir="build/doc">
        <include name="api/**/*"/>
        <include name="site/**/*"/>
      </fileset>
    </zip>

    <!-- src archive -->
    <zip destfile="${build.plugins}/org.eclim_${eclim.version}/src.zip">
      <fileset dir="src/java" includes="**/*"/>
    </zip>

    <!-- eclipse plugin archives -->
    <zip destfile="${build.installer}/org.eclim_${eclim.version}.zip">
      <fileset dir="${build.plugins}/">
        <include name="org.eclim_${eclim.version}/**/*"/>
        <include name="org.eclim.*_${eclim.version}/**/*"/>
        <exclude name="org.eclim.installer*_${eclim.version}/**/*"/>
        <exclude name="org.eclim.installer*_${eclim.version}"/>
        <exclude name="org.eclim_${eclim.version}/bin/native/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/ng"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclim*"/>
      </fileset>
      <zipfileset dir="src/shell" prefix="org.eclim_${eclim.version}/bin/">
        <include name="eclim"/>
        <include name="eclim*.bat"/>
        <include name="eclim*.cmd"/>
      </zipfileset>
    </zip>
    <tar destfile="${build.installer}/org.eclim_${eclim.version}.tar.gz"
        compression="gzip">
      <tarfileset dir="${build.plugins}/">
        <include name="org.eclim_${eclim.version}/**/*"/>
        <include name="org.eclim.*_${eclim.version}/**/*"/>
        <exclude name="org.eclim.installer*_${eclim.version}/**/*"/>
        <exclude name="org.eclim.installer*_${eclim.version}"/>
        <exclude name="org.eclim_${eclim.version}/bin/native/windows/**/*"/>
        <exclude name="org.eclim_${eclim.version}/bin/ng"/>
        <exclude name="org.eclim_${eclim.version}/bin/eclim*"/>
        <exclude name="org.eclim_${eclim.version}/bin/**/*.bat"/>
        <exclude name="org.eclim_${eclim.version}/bin/**/*.exe"/>
      </tarfileset>
      <tarfileset dir="src/shell"
          prefix="org.eclim_${eclim.version}/bin/" mode="755">
        <include name="eclim"/>
        <include name="eclim.sed"/>
        <include name="eclimd"/>
        <include name="eclimd.sed"/>
      </tarfileset>
    </tar>

    <!-- vim plugins jar -->
    <zip destfile="${build.installer}/eclim_vim_${eclim.version}.jar">
      <fileset dir="${build.vimfiles}" includes="**/*"/>
      <zipfileset dir="build/doc/vimdocs" prefix="eclim/doc">
        <include name="**/*.txt"/>
      </zipfileset>
    </zip>

    <antcall target="installer"/>

    <!-- full source tar -->
    <tar destfile="build/dist/eclim_${eclim.version}.tar.gz"
        compression="gzip">
      <tarfileset dir="." prefix="eclim_${eclim.version}">
        <include name="**/*"/>
        <exclude name=".git/**/*"/>
        <exclude name=".git/"/>
        <exclude name=".ropeproject/**/*"/>
        <exclude name=".ropeproject/"/>
        <exclude name="backup/**/*"/>
        <exclude name="backup/"/>
        <exclude name="build/**/*"/>
        <exclude name="build/"/>
      </tarfileset>
    </tar>
  </target>

  <!--
    - Target for creating installer files.
    -->
  <target name="installer">
    <!-- run formic -->
    <exec executable="${formic.home}/bin/formic" failonerror="true" dir=".">
      <arg value="-Declipse.home=${eclipse.home}"/>
      <arg value="-buildfile"/>
      <arg value="src/installer/build.xml"/>
    </exec>
  </target>

</project>
