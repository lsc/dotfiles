<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (C) 2005 - 2009  Eric Van Dewoestine

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<project name="docs" default="docs" basedir="../..">
  <!--
    - Target for generating the javadocs.
    -->
  <target name="javadoc" depends="init">
    <mkdir dir="build/doc/api"/>

    <property name="javadoc.include" value="org/eclim/plugin/core/**/*.java"/>
    <for list="${plugins}" param="plugin">
      <sequential>
        <var name="javadoc.include"
            value="org/eclim/plugin/@{plugin}/**/*.java,${javadoc.include}"/>
      </sequential>
    </for>

    <javadoc packagenames="org.eclim" destdir="build/doc/api">
      <classpath refid="classpath"/>
      <fileset dir="src/java">
        <include name="org/ec*/**/*.java"/>
        <include name="org/eclim/plugin/*.java"/>
        <exclude name="org/eclim/plugin/*/**/*.java"/>
      </fileset>
      <fileset dir="src/java" includes="${javadoc.include}"/>
    </javadoc>
  </target>

  <!--
    - Generates the eclim docs.
    -->
  <target name="docs" depends="init">
    <property name="sphinx.args" value=""/>
    <mkdir dir="build/doc/site"/>

    <!-- generate site documention via sphinx -->
    <exec executable="sphinx-build" failonerror="true" dir=".">
      <arg line="${sphinx.args} -b eclim src/doc/content build/doc/site"/>
    </exec>

    <!-- copy over any images that sphinx neglects to -->
    <copy todir="build/doc/site/_images">
      <fileset dir="src/doc/content/images" includes="**/*"/>
    </copy>

    <!-- copy over eclipse update/site.xml -->
    <copy todir="build/doc/site">
      <fileset dir="src/doc/content" includes="updates/**/*"/>
    </copy>

    <touch file="build/doc/site/google4c368e38cc6ac62e.html"/>
    <replace dir="build/doc/site" includes="**/*.html">
      <replacefilter token="$${eclim.version}" value="${eclim.version}"/>
      <replacefilter token="$${google.analytics}"/>
      <replacevalue><![CDATA[
      <!-- Google Analytics -->
        <script src="http://www.google-analytics.com/urchin.js"
          type="text/javascript">
        </script>
        <script type="text/javascript">
          _uacct = "UA-575508-1";
          urchinTracker();
        </script>
      <!-- End Google Analytics -->
      ]]></replacevalue>
    </replace>

    <!-- support for google sitemap -->
    <echo file="build/doc/site/sitemap.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">]]></echo>
    <for param="file">
      <path>
        <fileset dir="build/doc/site" includes="**/*.html"/>
      </path>
      <sequential>
        <propertyregex property="file" override="true" input="@{file}"
            regexp="${basedir}/build/doc/site/" replace=""/>
        <echo file="build/doc/site/sitemap.xml" append="true"><![CDATA[
<url><loc>http://eclim.sourceforge.net/${file}</loc></url>]]></echo>
      </sequential>
    </for>
    <echo file="build/doc/site/sitemap.xml" append="true"><![CDATA[
</urlset>]]></echo>
    <gzip src="build/doc/site/sitemap.xml"
        destfile="build/doc/site/sitemap.xml.gz"/>
    <delete file="build/doc/site/sitemap.xml"/>
  </target>

  <!--
    - Generates vim docs from sphinx files.
    -->
  <target name="vimdocs" depends="init">
    <property name="sphinx.args" value=""/>
    <mkdir dir="build/doc/vimdocs"/>

    <!-- generate site documention via sphinx -->
    <exec executable="sphinx-build" failonerror="true" dir=".">
      <arg line="${sphinx.args} -b vimdoc src/doc/content build/doc/vimdocs"/>
    </exec>

    <delete dir="${vim.files}/eclim/doc"/>
    <copy todir="${vim.files}/eclim/doc">
      <fileset dir="build/doc/vimdocs">
        <include name="**/*"/>
        <exclude name=".doctrees/**/*"/>
        <exclude name=".doctrees"/>
      </fileset>
    </copy>
  </target>

  <!--
    - Extracts all eclipse doc jars.
    -->
  <target name="eclipse.docs">
    <for param="doc.jar" delimiter=":">
      <path id="eclipse.docs">
        <fileset dir="${eclipse.home}/plugins" includes="*.doc.*.jar"/>
      </path>
      <sequential>
        <propertyregex override="yes" property="doc.dir" input="@{doc.jar}"
            regexp=".*(org.eclipse.*?)_.*" replace="\1"/>
        <unjar src="@{doc.jar}" dest="${eclipse.home}/docs/${doc.dir}"/>
      </sequential>
    </for>
  </target>

  <!--
    - Extracts all eclipse src zips.
    -->
  <target name="eclipse.src">
    <for param="src.zip" delimiter=":">
      <path id="eclipse.docs">
        <fileset dir="${eclipse.home}/plugins" includes="**/*.source_*.jar"/>
      </path>
      <sequential>
        <unjar src="@{src.zip}" dest="${eclipse.home}/src"/>
      </sequential>
    </for>
  </target>

</project>
